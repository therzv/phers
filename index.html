
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HR Data Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Ultra smooth moving sky blue gradient background */
    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(-45deg, 
        #87CEEB,   /* Sky blue */
        #E0F6FF,   /* Light blue */
        #B8E6FF,   /* Powder blue */
        #87CEFA,   /* Light sky blue */
        #ADD8E6,   /* Light blue */
        #E6F3FF,   /* Very light blue */
        #B0E0E6,   /* Powder blue */
        #87CEEB    /* Back to sky blue for seamless loop */
      );
      background-size: 600% 600%;
      animation: smoothSkyMove 25s linear infinite;
      position: relative;
      overflow-x: hidden;
      /* Hardware acceleration for ultra smooth performance */
      will-change: background-position;
      backface-visibility: hidden;
      perspective: 1000px;
      transform: translateZ(0);
    }
    
    /* Ultra smooth gradient animation - only moves position */
    @keyframes smoothSkyMove {
      0% { 
        background-position: 0% 50%; 
      }
      25% { 
        background-position: 100% 50%; 
      }
      50% { 
        background-position: 100% 100%; 
      }
      75% { 
        background-position: 0% 100%; 
      }
      100% { 
        background-position: 0% 50%; 
      }
    }
    
    /* Enhanced glass effect with floating animation */
    .glass { 
      background: rgba(255, 255, 255, 0.85); 
      backdrop-filter: blur(20px) saturate(180%); 
      box-shadow: 0 25px 50px rgba(8, 145, 178, 0.15), 
                  0 15px 35px rgba(8, 145, 178, 0.1),
                  inset 0 1px 0 rgba(255, 255, 255, 0.3); 
      border: 1px solid rgba(255, 255, 255, 0.2);
      animation: float 6s ease-in-out infinite;
    }
    
    /* Beautiful floating animation */
    @keyframes float {
      0%, 100% { 
        transform: translateY(0px) rotate(0deg); 
        box-shadow: 0 25px 50px rgba(8, 145, 178, 0.15), 
                    0 15px 35px rgba(8, 145, 178, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
      }
      50% { 
        transform: translateY(-10px) rotate(0.5deg); 
        box-shadow: 0 35px 60px rgba(8, 145, 178, 0.2), 
                    0 25px 45px rgba(8, 145, 178, 0.15),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4);
      }
    }
    
    /* Staggered animation for different containers */
    .company-header {
      animation-delay: -0.5s; /* Company header starts first */
    }
    
    .col-span-1.glass {
      animation-delay: 0.5s;
    }
    
    .col-span-2.glass {
      animation-delay: 1s;
    }
    
    /* Special styling for company header */
    .company-header {
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid rgba(135, 206, 235, 0.2);
    }
    
    .company-header:hover {
      border-color: rgba(135, 206, 235, 0.4);
    }
    
    /* Company logo container styling */
    .company-logo-container {
      position: relative;
    }
    
    .company-logo-container::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #87CEEB, #ADD8E6, #87CEFA, #B8E6FF);
      border-radius: 14px;
      z-index: -1;
      animation: logoGlow 3s ease-in-out infinite;
    }
    
    @keyframes logoGlow {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.6; }
    }
    
    /* Editable company name styling */
    .company-name {
      cursor: pointer;
      transition: color 0.3s ease;
    }
    
    .company-name:hover {
      color: #0891b2;
    }
    
    .company-tagline {
      font-style: italic;
    }
    
    /* Enhanced hover effects */
    .panel-floating { 
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
    }
    .panel-floating:hover { 
      transform: translateY(-12px) scale(1.02); 
      box-shadow: 0 40px 80px rgba(8, 145, 178, 0.25), 
                  0 30px 60px rgba(8, 145, 178, 0.18),
                  inset 0 1px 0 rgba(255, 255, 255, 0.4);
    }
    
    /* Smoother cloud-like effects */
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.08) 0%, transparent 60%),
                  radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.06) 0%, transparent 60%),
                  radial-gradient(circle at 40% 40%, rgba(135, 206, 235, 0.04) 0%, transparent 60%);
      animation: smoothClouds 30s linear infinite;
      pointer-events: none;
    }
    
    @keyframes smoothClouds {
      0% { 
        transform: translateX(0) translateY(0); 
        opacity: 0.8;
      }
      25% { 
        transform: translateX(-15px) translateY(-8px); 
        opacity: 1;
      }
      50% { 
        transform: translateX(15px) translateY(8px); 
        opacity: 0.9;
      }
      75% { 
        transform: translateX(-8px) translateY(15px); 
        opacity: 1;
      }
      100% { 
        transform: translateX(0) translateY(0); 
        opacity: 0.8;
      }
    }
    
    @media (prefers-reduced-motion: reduce) {
      body, .glass { animation: none !important; }
      .panel-floating { transition: none !important; }
      body::before { animation: none !important; }
    }
  </style>
</head>
<body>
  <div class="w-full max-w-6xl p-6">
    <!-- Company Branding Header -->
    <div class="glass rounded-2xl p-6 mb-6 panel-floating company-header">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <!-- Company Logo Placeholder -->
          <div class="company-logo-container">
            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg">
              <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
              </svg>
            </div>
          </div>
          <!-- Company Info -->
          <div>
            <h1 class="company-name text-2xl font-bold text-slate-800 mb-1">Your Company Name</h1>
            <p class="company-tagline text-sm text-slate-600">HR Data Intelligence Platform</p>
          </div>
        </div>
        <!-- System Status -->
        <div class="text-right">
          <div id="globalIndex" class="text-sm text-slate-600 mb-1">Index: idle</div>
          <div class="text-xs text-slate-500">Powered by AI</div>
        </div>
      </div>
    </div>
    
    <div class="grid grid-cols-3 gap-6">
      <!-- Left: upload & files -->
      <div class="col-span-1 glass rounded-xl p-5 shadow panel-floating">
        <h2 class="text-lg font-semibold mb-3">Documents</h2>
        <div id="dbInfo" class="mb-3 text-xs text-slate-600">
          <div class="font-medium">Database</div>
          <div id="dbPath">No DB</div>
          <div id="dbTables" class="mt-1"></div>
        </div>
        <div class="mb-3">
          <input id="fileInput" type="file" accept=".csv,.xlsx,.xls" class="block w-full text-sm text-slate-600" multiple />
          <div class="flex mt-2 gap-2">
            <button id="uploadBtn" class="flex-1 bg-indigo-600 text-white px-3 py-2 rounded">Upload</button>
            <button id="refreshFiles" class="px-3 py-2 border rounded">Refresh</button>
          </div>
          <p id="uploadStatus" class="text-xs text-slate-500 mt-2"></p>
        </div>

        <div>
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-medium">Uploaded Files</h3>
            <div class="flex gap-1">
              <button id="activateAll" class="text-xs px-2 py-1 bg-emerald-100 text-emerald-700 rounded hover:bg-emerald-200">All On</button>
              <button id="deactivateAll" class="text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">All Off</button>
            </div>
          </div>
          <div id="activeFilesInfo" class="text-xs text-slate-600 mb-2 p-2 bg-blue-50 rounded hidden">
            <div class="font-medium">Active Files:</div>
            <div id="activeFilesList">None</div>
          </div>
          <div id="filesList" class="space-y-2 max-h-40 overflow-auto text-sm"></div>
        </div>
        <div class="mt-4">
          <h3 class="text-sm font-medium mb-2">Activity</h3>
          <div id="activityFeed" class="space-y-2 max-h-40 overflow-auto text-sm text-slate-600 p-2 bg-white rounded"></div>
        </div>
        <!-- chooser for ambiguous file matches -->
        <div id="chooser" class="mt-3 hidden">
          <div class="text-sm font-medium mb-2">Which file did you mean?</div>
          <div id="chooserList" class="space-y-2 text-sm"></div>
        </div>
      </div>

      <!-- Middle: chat -->
  <div class="col-span-2 glass rounded-xl p-5 shadow flex flex-col panel-floating">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h1 class="text-2xl font-bold text-slate-800">HR Data Chat</h1>
            <p class="text-sm text-slate-600 mt-1">Ask natural questions about your HR data</p>
          </div>
          <div class="text-right">
            <div class="text-sm text-slate-500">Powered by Ollama + Phi4</div>
            <div id="llmStatus" class="text-xs text-emerald-600">🟢 AI Ready</div>
          </div>
        </div>

        <div id="chat" class="flex-1 overflow-auto p-4 space-y-3 bg-gradient-to-b from-white to-slate-50 rounded border"></div>

        <div class="mt-4">
          <!-- Example questions -->
          <div id="exampleQuestions" class="mb-3 flex flex-wrap gap-2">
            <button class="example-q px-3 py-1 bg-slate-100 text-slate-700 rounded-full text-sm hover:bg-slate-200 transition-colors" data-question="How many assets are in repair status?">How many assets are in repair?</button>
            <button class="example-q px-3 py-1 bg-slate-100 text-slate-700 rounded-full text-sm hover:bg-slate-200 transition-colors" data-question="What is the total value of all machinery?">Total machinery value?</button>
            <button class="example-q px-3 py-1 bg-slate-100 text-slate-700 rounded-full text-sm hover:bg-slate-200 transition-colors" data-question="Show me all assets in Seattle">Assets in Seattle?</button>
            <button class="example-q px-3 py-1 bg-slate-100 text-slate-700 rounded-full text-sm hover:bg-slate-200 transition-colors" data-question="Count assets by category">Assets by category?</button>
          </div>
          
          <form id="form" class="flex gap-2">
            <input id="input" type="text" placeholder="Ask about assets, values, locations, status..." class="flex-1 px-4 py-3 rounded-lg border border-slate-300 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 outline-none" />
            <button type="submit" id="sendBtn" class="bg-emerald-600 text-white px-6 py-3 rounded-lg hover:bg-emerald-700 transition-colors font-medium">
              <span class="send-text">Ask AI</span>
              <span class="loading-text hidden">...</span>
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- SQL Preview Modal -->
  <div id="sqlModal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 bg-black opacity-40" onclick="document.getElementById('cancelSql').click()"></div>
    <div class="bg-white rounded-lg p-4 z-50 w-11/12 max-w-2xl panel-floating relative">
      <!-- Close button -->
      <button onclick="document.getElementById('cancelSql').click()" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 text-xl font-bold">&times;</button>
      <h3 class="font-semibold mb-2">Generated SQL (preview)</h3>
      <pre id="sqlText" class="bg-slate-50 p-3 rounded text-xs max-h-48 overflow-auto"></pre>
      <div id="sqlSuggestions" class="text-sm text-slate-600 mt-2"></div>
      <div id="sqlInferred" class="text-sm text-slate-600 mt-2"></div>
      <div class="mt-4 flex gap-2 justify-end">
        <button id="cancelSql" class="px-3 py-2 border rounded">Cancel</button>
        <button id="runSql" class="px-3 py-2 bg-emerald-600 text-white rounded">Run SQL</button>
      </div>
    </div>
  </div>

<script>
const chatEl = document.getElementById("chat");
const form = document.getElementById("form");
const input = document.getElementById("input");
const uploadBtn = document.getElementById("uploadBtn");
const fileInput = document.getElementById("fileInput");
const uploadStatus = document.getElementById("uploadStatus");
  const filesList = document.getElementById("filesList");
  const globalIndex = document.getElementById('globalIndex');
  const chooser = document.getElementById('chooser');
const refreshFiles = document.getElementById("refreshFiles");
const sqlModal = document.getElementById('sqlModal');
const sqlText = document.getElementById('sqlText');
const sqlSuggestions = document.getElementById('sqlSuggestions');
const sqlInferred = document.getElementById('sqlInferred');
const cancelSql = document.getElementById('cancelSql');
const runSql = document.getElementById('runSql');
const chooserList = document.getElementById('chooserList');
const activityFeed = document.getElementById('activityFeed');
const sendBtn = document.getElementById('sendBtn');
const sendText = sendBtn.querySelector('.send-text');
const loadingText = sendBtn.querySelector('.loading-text');
const activateAllBtn = document.getElementById('activateAll');
const deactivateAllBtn = document.getElementById('deactivateAll');
const activeFilesInfo = document.getElementById('activeFilesInfo');
const activeFilesList = document.getElementById('activeFilesList');

// Handle example question clicks
document.querySelectorAll('.example-q').forEach(btn => {
  btn.addEventListener('click', () => {
    const question = btn.dataset.question;
    input.value = question;
    form.dispatchEvent(new Event('submit'));
  });
});

// Bulk activation controls
activateAllBtn.addEventListener('click', async () => {
  activateAllBtn.disabled = true;
  activateAllBtn.innerText = 'Activating...';
  try {
    const res = await fetch('/files/activate-all', { method: 'POST' });
    const data = await res.json();
    if (res.ok) {
      await loadFiles();
      toast(data.message);
    } else {
      toast('Failed to activate all files');
    }
  } catch (e) {
    toast('Request failed: ' + e);
  }
  activateAllBtn.disabled = false;
  activateAllBtn.innerText = 'All On';
});

deactivateAllBtn.addEventListener('click', async () => {
  deactivateAllBtn.disabled = true;
  deactivateAllBtn.innerText = 'Deactivating...';
  try {
    const res = await fetch('/files/deactivate-all', { method: 'POST' });
    const data = await res.json();
    if (res.ok) {
      await loadFiles();
      toast(data.message);
    } else {
      toast('Failed to deactivate all files');
    }
  } catch (e) {
    toast('Request failed: ' + e);
  }
  deactivateAllBtn.disabled = false;
  deactivateAllBtn.innerText = 'All Off';
});

function setLoading(loading) {
  sendBtn.disabled = loading;
  if (loading) {
    sendText.classList.add('hidden');
    loadingText.classList.remove('hidden');
    sendBtn.classList.add('opacity-75');
  } else {
    sendText.classList.remove('hidden');
    loadingText.classList.add('hidden');
    sendBtn.classList.remove('opacity-75');
  }
}

function toast(msg){
  const t = document.createElement('div');
  t.className = 'fixed right-6 bottom-6 bg-white p-3 rounded shadow panel-floating text-sm';
  t.innerText = msg;
  document.body.appendChild(t);
  setTimeout(()=>{ t.style.opacity = '0'; setTimeout(()=>t.remove(), 350); }, 4000);
}

function addMessage(role, text, tablePreview) {
  const wrapper = document.createElement("div");
  wrapper.className = "flex " + (role === "user" ? "justify-end" : "justify-start");
  const bubble = document.createElement("div");
  bubble.className = (role === "user" ? "bg-indigo-600 text-white" : "bg-white border") + " px-4 py-2 rounded-lg max-w-3xl";
  bubble.innerText = text;
  wrapper.appendChild(bubble);
  if (tablePreview && tablePreview.length) {
    const table = document.createElement("div");
    table.className = "mt-2 overflow-auto text-xs bg-slate-50 border p-2 rounded";
    const keys = Object.keys(tablePreview[0] || {});
    if (keys.length) {
      const t = document.createElement("table");
      t.className = "min-w-full border-collapse text-left text-xs";
      const thead = document.createElement("thead");
      const trh = document.createElement("tr");
      keys.forEach(k=>{
        const th = document.createElement("th");
        th.innerText = k;
        th.className = "px-2 py-1 text-slate-600";
        trh.appendChild(th);
      });
      thead.appendChild(trh);
      t.appendChild(thead);
      const tbody = document.createElement("tbody");
      tablePreview.forEach(row=>{
        const tr = document.createElement("tr");
        keys.forEach(k=>{
          const td = document.createElement("td");
          td.innerText = row[k] ?? "";
          td.className = "px-2 py-1";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      t.appendChild(tbody);
      table.appendChild(t);
    } else {
      table.innerText = JSON.stringify(tablePreview, null, 2);
    }
    wrapper.appendChild(table);
  }
  chatEl.appendChild(wrapper);
  chatEl.scrollTop = chatEl.scrollHeight;
  return wrapper;
}

function parseSummary(summaryRaw){
  if(!summaryRaw) return '';
  let s = summaryRaw.trim();
  // strip fenced codeblocks
  const codeMatch = s.match(/```(?:json)?\n?([\s\S]*?)```/i);
  if(codeMatch){ s = codeMatch[1].trim(); }
  // try parse JSON
  try{
    const obj = JSON.parse(s);
    if(obj && obj.text) return obj.text;
  }catch(e){}
  // fallback: remove any surrounding backticks
  s = s.replace(/^`+|`+$/g, '').trim();
  return s;
}

async function renderAssistantResponse(resp, title){
  // resp: { summary, table_preview, suggestions }
  const summaryText = parseSummary(resp.summary || resp.text || '');
  const wrapper = addMessage('assistant', title ? title + '\n' + summaryText : (summaryText || 'No summary'), []);
  // Beautiful AI-powered suggestions
  const suggestions = resp.suggestions || [];
  if(suggestions && suggestions.length){
    const suggestionsContainer = document.createElement('div');
    suggestionsContainer.className = 'mt-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200';
    
    // Header for suggestions
    const header = document.createElement('div');
    header.className = 'flex items-center gap-2 mb-3';
    header.innerHTML = `
      <div class="w-6 h-6 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center">
        <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
        </svg>
      </div>
      <h4 class="font-medium text-slate-800">AI Suggestions</h4>
    `;
    suggestionsContainer.appendChild(header);
    
    const chips = document.createElement('div');
    chips.className = 'flex gap-2 flex-wrap';
    
    suggestions.forEach((s, idx)=>{
      const btn = document.createElement('button');
      btn.className = 'group flex items-center gap-2 px-4 py-2 bg-white text-slate-700 rounded-lg border border-slate-200 hover:border-blue-300 hover:bg-blue-50 transition-all duration-200 shadow-sm hover:shadow-md';
      
      // Smart labeling based on suggestion type
      let label = 'Try suggestion';
      let icon = '💡';
      
      // Use the new smart suggestion format if available
      if (s.label) {
        label = s.label;
        icon = s.icon || '💡';
      } else if (s.candidates && s.candidates.length) {
        const candidate = s.candidates[0];
        if (candidate.includes('Asset')) {
          label = `Search in "${candidate}"`;
          icon = '🏷️';
        } else if (candidate.includes('Manufacturer')) {
          label = `Check "${candidate}"`;
          icon = '🏭';
        } else if (candidate.includes('Name')) {
          label = `Look in "${candidate}"`;
          icon = '📝';
        } else {
          label = `Try "${candidate}"`;
          icon = '🔍';
        }
      } else if (s.original) {
        label = `Try "${s.original}"`;
        icon = '✨';
      }
      
      btn.innerHTML = `
        <span class="text-lg">${icon}</span>
        <span class="font-medium">${label}</span>
        <svg class="w-4 h-4 text-slate-400 group-hover:text-blue-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      `;
      btn.addEventListener('click', async ()=>{
        btn.disabled = true;
        btn.innerHTML = `
          <svg class="animate-spin w-4 h-4 text-blue-500" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span class="font-medium">Applying...</span>
        `;
        try{
          const sq = (s.suggested_sqls && s.suggested_sqls[0]) || s.suggested_sql || s.sql;
          const r = await fetch('/execute_sql', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sql: sq, question: (input.value||'') }) });
          const d = await r.json();
          if(!r.ok){
            toast('Suggestion failed: ' + (d.detail || JSON.stringify(d)));
            btn.disabled = false;
            btn.innerHTML = `
              <span class="text-lg">${icon}</span>
              <span class="font-medium">${label}</span>
              <svg class="w-4 h-4 text-slate-400 group-hover:text-blue-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            `;
            return;
          }
          // render the response (natural language + preview)
          await renderAssistantResponse(d, `Result for suggestion: ${label}`);
        }catch(err){
          toast('Suggestion request failed: ' + err);
          btn.disabled = false;
          btn.innerHTML = `
            <span class="text-lg">${icon}</span>
            <span class="font-medium">${label}</span>
            <svg class="w-4 h-4 text-slate-400 group-hover:text-blue-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          `;
        }
      });
      chips.appendChild(btn);
    });
    
    suggestionsContainer.appendChild(chips);
    wrapper.appendChild(suggestionsContainer);
    chatEl.scrollTop = chatEl.scrollHeight;
  }
}

async function loadFiles() {
  try {
    const res = await fetch('/files');
    const data = await res.json();
    filesList.innerHTML = '';
    data.files.forEach(f=>{
      const el = document.createElement('div');
  el.className = `p-2 border rounded flex flex-col gap-2 ${f.active ? 'border-emerald-300 bg-emerald-50' : 'border-gray-200 bg-gray-50 opacity-75'}`;
  el.innerHTML = `
    <div class="flex items-center justify-between">
      <div>
        <div class="flex items-center gap-2">
          <div class="font-medium">${f.filename}</div>
          <span class="text-xs px-2 py-1 rounded-full ${f.active ? 'bg-emerald-100 text-emerald-800' : 'bg-gray-100 text-gray-500'}">${f.active ? '✓ Active' : '⭕ Inactive'}</span>
        </div>
        <div class="text-xs text-slate-500">table: ${f.table}</div>
      </div>
    </div>
    <div class="w-full bg-slate-100 rounded h-2 overflow-hidden">
      <div id="bar-${f.filename}" class="h-2 bg-emerald-400" style="width:0%"></div>
    </div>`;
      const actions = document.createElement('div');
      actions.className = 'flex gap-2 mt-2';
      
      // activation toggle button
      const toggle = document.createElement('button');
      toggle.className = `px-2 py-1 rounded border text-xs ${f.active ? 'bg-orange-100 text-orange-700 border-orange-200 hover:bg-orange-200' : 'bg-emerald-100 text-emerald-700 border-emerald-200 hover:bg-emerald-200'}`;
      toggle.innerText = f.active ? 'Deactivate' : 'Activate';
      toggle.addEventListener('click', async ()=>{
        toggle.disabled = true;
        toggle.innerText = 'Updating...';
        try{
          const r = await fetch(`/files/${encodeURIComponent(f.filename)}/toggle`, { method: 'POST' });
          const d = await r.json();
          if (r.ok) {
            await loadFiles(); // Refresh the file list
            toast(d.message);
          } else {
            toast('Toggle failed: ' + (d.detail || JSON.stringify(d)));
          }
        }catch(e){
          toast('Toggle request failed: ' + e);
        }
        toggle.disabled = false;
      });
      actions.appendChild(toggle);
      
      // preview button
      const prev = document.createElement('button');
      prev.className = 'text-slate-700 px-2 py-1 rounded border bg-white hover:bg-slate-50 text-xs';
      prev.innerText = 'Preview';
      prev.addEventListener('click', async ()=>{
        prev.disabled = true;
        prev.innerText = 'Loading...';
        try{
          const sql = `SELECT * FROM "${f.table}" LIMIT 10`;
          const r = await fetch('/execute_sql', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ sql: sql, question: `Preview ${f.table}` }) });
          
          let d;
          try {
            d = await r.json();
          } catch (jsonError) {
            // If JSON parsing fails, try to get text response
            const text = await r.text();
            toast('Preview failed: Server returned invalid JSON. ' + (text.substring(0, 100) + '...'));
            return;
          }
          
          if (!r.ok){
            toast('Preview failed: ' + (d.detail || JSON.stringify(d)));
          } else {
            // show preview in chat as assistant message
            addMessage('assistant', `Preview of ${f.filename}`, d.table_preview || d.rows || []);
          }
        }catch(e){
          toast('Preview request failed: ' + e);
        }
        prev.disabled = false;
        prev.innerText = 'Preview';
      });
      actions.appendChild(prev);
      // delete button
      const del = document.createElement('button');
      del.className = 'text-red-600 px-2 py-1 rounded border bg-white hover:bg-red-50 text-xs';
      del.innerText = 'Delete';
      del.addEventListener('click', async ()=>{
        if (!confirm(`Delete ${f.filename}? This removes the file, its SQL table, and any RAG entries.`)) return;
        try {
          const res = await fetch(`/files/${encodeURIComponent(f.filename)}`, { method: 'DELETE' });
          if (res.ok) {
            await loadFiles();
          } else {
            const data = await res.json();
            alert('Delete failed: ' + (data.detail || JSON.stringify(data)));
          }
        } catch (e) {
          alert('Delete request failed: ' + e);
        }
      });
      actions.appendChild(del);
      el.appendChild(actions);
      filesList.appendChild(el);
    });
    
    // Update active files info
    const activeFiles = data.files.filter(f => f.active);
    if (activeFiles.length > 0) {
      activeFilesInfo.classList.remove('hidden');
      activeFilesList.innerHTML = activeFiles.map(f => f.filename).join(', ');
    } else {
      activeFilesInfo.classList.add('hidden');
      activeFilesList.innerHTML = 'None';
    }
    
    // then fetch indexing statuses and update badges
    try{
      const st = await fetch('/index_status');
      const js = await st.json();
      const s = js.status || {};
      let anyIndexing = false;
      Object.keys(s).forEach(fname=>{
        const info = s[fname];
        if (!info) return;
        const progress = Math.round((info.progress || 0)*100);
        const bar = document.getElementById('bar-'+fname);
        if (bar) {
          bar.style.width = `${progress}%`;
        }
        if (info.status === 'indexing'){
          anyIndexing = true;
        }
        // when just finished, push to activity feed and show toast
        if (info.status === 'done' && !document.getElementById('act-'+fname)){
          const feedItem = document.createElement('div');
          feedItem.id = 'act-'+fname;
          feedItem.innerHTML = `<div class="font-medium text-slate-700">Indexed ${fname}</div><div class="text-xs text-slate-500">Finished: ${info.finished || ''} • ${info.count||0} docs</div>`;
          activityFeed.prepend(feedItem);
          toast(`Indexing finished: ${fname}`);
        }
        if (info.status === 'error' && !document.getElementById('act-'+fname+'-err')){
          const feedItem = document.createElement('div');
          feedItem.id = 'act-'+fname+'-err';
          feedItem.innerHTML = `<div class="font-medium text-rose-600">Index error: ${fname}</div><div class="text-xs text-slate-500">${info.message || 'error'}</div>`;
          activityFeed.prepend(feedItem);
          toast(`Indexing error: ${fname}`);
        }
      })
      globalIndex.innerText = anyIndexing ? 'Indexing in progress...' : 'Index: idle';
    }catch(e){/* ignore */}
    // fetch db info
    try{
      const db = await fetch('/db_info');
      const d = await db.json();
      const dbPathEl = document.getElementById('dbPath');
      const dbTablesEl = document.getElementById('dbTables');
      if (d.db_path) dbPathEl.innerText = d.db_path;
      dbTablesEl.innerHTML = d.tables && d.tables.length ? ('Tables: ' + d.tables.join(', ')) : 'No tables';
    }catch(e){/* ignore */}
  } catch (e) {
    filesList.innerText = 'Failed to load files';
  }
}

// poll indexing status periodically
setInterval(()=>{ loadFiles(); }, 6000);

uploadBtn.addEventListener('click', async ()=>{
  const files = fileInput.files;
  if (!files || !files.length) {
    uploadStatus.innerText = 'Choose at least one file.';
    return;
  }
  uploadStatus.innerText = 'Uploading...';
  for (let i=0;i<files.length;i++){
    const file = files[i];
    const fd = new FormData();
    fd.append('file', file);
    
    try {
      const res = await fetch('/upload', { method: 'POST', body: fd });
      const data = await res.json();
      
      if (res.ok) {
        // Debug log to see what we received
        console.log('Upload response:', data);
        
        // If sanitation was performed, show the modal
        if (data.sanitized && data.sanitation_report) {
          const fileSize = `${(file.size / 1024).toFixed(1)} KB`;
          
          try {
            // Show sanitation modal with animated steps
            showSanitationModal(file.name, fileSize, `${data.sanitation_report.rows_processed} rows`);
            
            // Animate the steps
            updateSanitationStep('columns', 'processing');
            await new Promise(resolve => setTimeout(resolve, 400));
            updateSanitationStep('columns', 'completed');
            
            updateSanitationStep('data', 'processing');
            await new Promise(resolve => setTimeout(resolve, 300));
            updateSanitationStep('data', 'completed');
            
            updateSanitationStep('indexing', 'processing');
            await new Promise(resolve => setTimeout(resolve, 400));
            updateSanitationStep('indexing', 'completed');
            
            // Show results
            showSanitationResults(data.sanitation_report);
            uploadStatus.innerText = `Processed: ${file.name} (issues found and fixed)`;
            
            // Safe toast call
            try {
              toast(`✨ ${file.name} processed - data cleaned for optimal performance!`);
            } catch (toastErr) {
              console.log('Toast failed:', toastErr);
            }
          } catch (modalErr) {
            console.log('Sanitation modal failed:', modalErr);
            uploadStatus.innerText = `Uploaded: ${file.name} (cleaned)`;
          }
        } else {
          // Normal upload without sanitation
          uploadStatus.innerText = `Uploaded: ${file.name}`;
          try {
            toast(`✅ ${file.name} uploaded successfully!`);
          } catch (toastErr) {
            console.log('Toast failed:', toastErr);
          }
        }
      } else {
        uploadStatus.innerText = 'Upload error: ' + (data.detail || JSON.stringify(data));
        toast(`❌ Upload failed: ${file.name}`);
      }
    } catch (e) {
      uploadStatus.innerText = 'Upload failed: ' + e;
      toast(`❌ Upload failed: ${file.name}`);
    }
  }
  await loadFiles();
});

refreshFiles.addEventListener('click', loadFiles);

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const q = input.value.trim();
  if (!q) return;
  
  setLoading(true);
  addMessage('user', q);
  input.value = '';
  
  const thinkingMsg = addMessage('assistant', '🤔 Analyzing your question and searching the data...');
  
  try {
    const res = await fetch('/chat', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ question: q }) });
    const data = await res.json();
    // Remove thinking message
    thinkingMsg.remove();
    
    if (!res.ok) {
      addMessage('assistant', '❌ Error: ' + (data.detail || JSON.stringify(data)));
      setLoading(false);
      return;
    }
    // if no inferred tables and no suggestions, ask server for candidate files when ambiguous
    if ((!data.inferred_tables || !data.inferred_tables.length)){
      try{
        const pick = await fetch('/choose_file', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ question: q }) });
        const pickRes = await pick.json();
        if (pick.ok === false || !pickRes.candidates) {
          // ignore
        } else {
          const cand = pickRes.candidates || [];
          if (cand.length>1 && Math.abs((cand[0].score||0)-(cand[1].score||0)) < 0.6){
            // ambiguous — show chooser UI
            chooserList.innerHTML='';
            cand.forEach(c=>{
              const el = document.createElement('div');
              el.className='p-2 border rounded flex items-center justify-between';
              el.innerHTML = `<div><div class="font-medium">${c.filename}</div><div class="text-xs text-slate-500">table: ${c.table}</div></div>`
              const btn = document.createElement('button');
              btn.className='px-2 py-1 bg-indigo-600 text-white rounded';
              btn.innerText='Use this file';
              btn.addEventListener('click', ()=>{
                chooser.classList.add('hidden');
                // prefill question including explicit file hint and re-run preview flow
                const newQ = q + ` in file ${c.filename}`;
                input.value = newQ;
                form.dispatchEvent(new Event('submit'));
              });
              el.appendChild(btn);
              chooserList.appendChild(el);
            });
            chooser.classList.remove('hidden');
            return; // stop preview modal from showing; user will re-submit via chooser
          }
        }
      }catch(e){/*ignore chooser errors*/}
    }

    // If server returned no SQL (pandas-ai / dataframe-first flow), show the summary directly
    if (!data.sql) {
      // pandas-ai or direct summary path
      // render natural summary and preview
      await renderAssistantResponse(data);
      return;
    }
    // Automatically run the generated SQL and show a natural-language result + suggestions.
    // Keep the SQL preview modal as a manual "Show SQL" option.
    try{
      const executingMsg = addMessage('assistant', '⚡ Running SQL and composing an answer...');
      const exec = await fetch('/execute_sql', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ sql: data.sql, question: q }) });
      executingMsg.remove();
      
      let execData;
      const response = exec.clone(); // Clone so we can read it multiple ways
      try {
        execData = await exec.json();
      } catch (jsonError) {
        console.error('JSON parsing error:', jsonError);
        // Try to get the raw text response for debugging
        const rawText = await response.text();
        console.error('Raw response:', rawText);
        throw new Error(`Server returned invalid JSON: ${rawText.substring(0, 200)}...`);
      }
      if (!exec.ok) {
        // if server complains about unknown table, offer candidate chooser
        if (exec.status === 400 && execData && execData.detail && exec.headers.get('X-Candidates')) {
          try{
            const candidates = JSON.parse(exec.headers.get('X-Candidates'));
            // show chooser UI
            chooserList.innerHTML = '';
            candidates.forEach(c=>{
              const el = document.createElement('div');
              el.className='p-2 border rounded flex items-center justify-between';
              el.innerHTML = `<div><div class="font-medium">${c.filename}</div><div class="text-xs text-slate-500">table: ${c.table}</div></div>`;
              const btn = document.createElement('button');
              btn.className='px-2 py-1 bg-indigo-600 text-white rounded';
              btn.innerText='Use this file';
              btn.addEventListener('click', ()=>{
                chooser.classList.add('hidden');
                input.value = q + ` in file ${c.filename}`;
                form.dispatchEvent(new Event('submit'));
              });
              el.appendChild(btn);
              chooserList.appendChild(el);
            });
            chooser.classList.remove('hidden');
          }catch(e){
            addMessage('assistant', 'Execution error: ' + (execData.detail || JSON.stringify(execData)));
          }
        } else {
          addMessage('assistant', '❌ Execution error: ' + (execData.detail || JSON.stringify(execData)));
        }
      } else {
        // render natural-language summary + preview + suggestions
        await renderAssistantResponse(execData);
      }
      // still populate SQL preview modal content for transparency; user can open it manually
      sqlText.innerText = data.sql || '';
      sqlSuggestions.innerText = data.suggestions && data.suggestions.length ? ('Suggestions: ' + data.suggestions.join(' | ')) : '';
      sqlInferred.innerText = data.inferred_tables && data.inferred_tables.length ? ('Likely tables: ' + data.inferred_tables.join(', ')) : '';
    }catch(err){
      addMessage('assistant', '❌ Execution request failed: ' + err);
      // Instead of showing modal, let's just show the error
      console.error('Execution failed:', err);
      // Only show SQL modal if user specifically requests it
      // sqlText.innerText = data.sql || '';
      // sqlModal.classList.remove('hidden');
    }
  } catch (err) {
    addMessage('assistant', '❌ Request failed: ' + err);
  } finally {
    setLoading(false);
  }
});

// Company name editing functionality
const companyName = document.querySelector('.company-name');
const companyTagline = document.querySelector('.company-tagline');

companyName.addEventListener('click', () => {
  const currentName = companyName.innerText;
  const input = document.createElement('input');
  input.type = 'text';
  input.value = currentName;
  input.className = 'text-2xl font-bold text-slate-800 bg-transparent border-b-2 border-blue-400 outline-none';
  input.style.width = '300px';
  
  companyName.parentNode.replaceChild(input, companyName);
  input.focus();
  input.select();
  
  const saveEdit = () => {
    const newName = input.value.trim() || 'Your Company Name';
    companyName.innerText = newName;
    input.parentNode.replaceChild(companyName, input);
    localStorage.setItem('companyName', newName);
    toast(`Company name updated to: ${newName}`);
  };
  
  input.addEventListener('blur', saveEdit);
  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') saveEdit();
  });
});

// Load saved company name
const savedName = localStorage.getItem('companyName');
if (savedName) {
  companyName.innerText = savedName;
}

// Sanitation Modal Functions
const sanitationModal = document.getElementById('sanitationModal');
const sanitationFileName = document.getElementById('sanitationFileName');
const sanitationFileDetails = document.getElementById('sanitationFileDetails'); 
const sanitationStatus = document.getElementById('sanitationStatus');
const sanitationIssues = document.getElementById('sanitationIssues');
const sanitationIssuesList = document.getElementById('sanitationIssuesList');
const sanitationComparison = document.getElementById('sanitationComparison');
const originalColumns = document.getElementById('originalColumns');
const cleanedColumns = document.getElementById('cleanedColumns');
const sanitationActions = document.getElementById('sanitationActions');
const sanitationClose = document.getElementById('sanitationClose');
const sanitationContinue = document.getElementById('sanitationContinue');

function showSanitationModal(filename, fileSize, rowCount) {
  if (!sanitationFileName || !sanitationFileDetails) {
    console.error('Sanitation modal elements not found');
    return;
  }
  sanitationFileName.textContent = filename;
  sanitationFileDetails.textContent = `${fileSize} • ${rowCount} rows`;
  
  // Reset modal state
  document.querySelectorAll('.sanitation-step').forEach(step => {
    const indicator = step.querySelector('div > div');
    indicator.className = 'w-2 h-2 bg-slate-400 rounded-full';
  });
  sanitationIssues.classList.add('hidden');
  sanitationComparison.classList.add('hidden');  
  sanitationActions.classList.add('hidden');
  sanitationStatus.innerHTML = `
    <div class="animate-spin w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full"></div>
    <span class="text-sm font-medium">Processing...</span>
  `;
  
  // Show modal
  sanitationModal.classList.remove('hidden');
  sanitationModal.classList.add('flex');
}

function updateSanitationStep(stepName, status = 'processing') {
  const step = document.querySelector(`[data-step="${stepName}"]`);
  if (!step) {
    console.error(`Sanitation step ${stepName} not found`);
    return;
  }
  const indicator = step.querySelector('div > div');
  if (!indicator) {
    console.error(`Sanitation step indicator for ${stepName} not found`);
    return;
  }
  
  if (status === 'processing') {
    indicator.className = 'w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin';
  } else if (status === 'completed') {
    indicator.className = 'w-4 h-4 bg-green-500 rounded-full flex items-center justify-center';
    indicator.innerHTML = '<svg class="w-2 h-2 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>';
  } else if (status === 'error') {
    indicator.className = 'w-4 h-4 bg-red-500 rounded-full flex items-center justify-center';
    indicator.innerHTML = '<svg class="w-2 h-2 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>';
  }
}

function showSanitationResults(report) {
  // Update status to completed
  sanitationStatus.innerHTML = `
    <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
    </svg>
    <span class="text-sm font-medium text-green-600">Completed</span>
  `;
  
  // Show issues if any were found
  if (report.issues_found && report.issues_found.length > 0) {
    sanitationIssues.classList.remove('hidden');
    sanitationIssuesList.innerHTML = '';
    
    report.issues_found.forEach(issue => {
      const issueEl = document.createElement('div');
      issueEl.className = 'flex items-center justify-between p-2 bg-yellow-50 rounded-lg border-l-4 border-yellow-400';
      issueEl.innerHTML = `
        <div>
          <div class="font-mono text-sm">${issue.original}</div>
          <div class="text-xs text-slate-600">${issue.issues.join(', ')}</div>
        </div>
        <div class="font-mono text-sm text-green-600">→ ${issue.cleaned}</div>
      `;
      sanitationIssuesList.appendChild(issueEl);
    });
  }
  
  // Show before/after comparison if columns were changed
  if (report.original_columns && report.cleaned_columns) {
    sanitationComparison.classList.remove('hidden');
    
    originalColumns.innerHTML = '';
    cleanedColumns.innerHTML = '';
    
    report.original_columns.forEach(col => {
      const colEl = document.createElement('div');
      colEl.className = 'px-2 py-1 bg-red-50 rounded text-red-700';
      colEl.textContent = col;
      originalColumns.appendChild(colEl);
    });
    
    report.cleaned_columns.forEach(col => {
      const colEl = document.createElement('div');
      colEl.className = 'px-2 py-1 bg-green-50 rounded text-green-700';
      colEl.textContent = col;
      cleanedColumns.appendChild(colEl);
    });
  }
  
  // Show action buttons
  sanitationActions.classList.remove('hidden');
}

// Modal event handlers with null checks
if (sanitationClose) {
  sanitationClose.addEventListener('click', () => {
    if (sanitationModal) {
      sanitationModal.classList.add('hidden');
      sanitationModal.classList.remove('flex');
    }
  });
}

if (sanitationContinue) {
  sanitationContinue.addEventListener('click', async () => {
    if (sanitationModal) {
      sanitationModal.classList.add('hidden');
      sanitationModal.classList.remove('flex');
    }
    // Refresh files list to show the newly processed file
    await loadFiles();
    toast('Ready to chat with your clean data! 🚀');
  });
}

// Close modal when clicking backdrop
if (sanitationModal) {
  sanitationModal.addEventListener('click', (e) => {
    if (e.target === sanitationModal && sanitationClose) {
      sanitationClose.click();
    }
  });
}

// initial load
loadFiles();
</script>

<!-- Data Sanitation Progress Modal -->
<div id="sanitationModal" class="fixed inset-0 hidden items-center justify-center z-50">
  <div class="absolute inset-0 bg-black opacity-50"></div>
  <div class="bg-white rounded-2xl p-8 z-50 w-11/12 max-w-3xl panel-floating shadow-2xl">
    <!-- Header -->
    <div class="flex items-center gap-3 mb-6">
      <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </div>
      <div>
        <h3 class="text-xl font-bold text-slate-800">Data Sanitation</h3>
        <p class="text-sm text-slate-600">Cleaning your data for optimal performance</p>
      </div>
    </div>
    
    <!-- File Info -->
    <div id="sanitationFileInfo" class="bg-slate-50 rounded-lg p-4 mb-6">
      <div class="flex items-center justify-between">
        <div>
          <h4 id="sanitationFileName" class="font-medium text-slate-800"></h4>
          <p id="sanitationFileDetails" class="text-sm text-slate-600"></p>
        </div>
        <div id="sanitationStatus" class="flex items-center gap-2">
          <div class="animate-spin w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full"></div>
          <span class="text-sm font-medium">Processing...</span>
        </div>
      </div>
    </div>
    
    <!-- Progress Steps -->
    <div id="sanitationSteps" class="space-y-4 mb-6">
      <div class="sanitation-step" data-step="columns">
        <div class="flex items-center gap-3">
          <div class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center">
            <div class="w-2 h-2 bg-slate-400 rounded-full"></div>
          </div>
          <span class="font-medium text-slate-700">Cleaning column names</span>
        </div>
      </div>
      
      <div class="sanitation-step" data-step="data">
        <div class="flex items-center gap-3">
          <div class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center">
            <div class="w-2 h-2 bg-slate-400 rounded-full"></div>
          </div>
          <span class="font-medium text-slate-700">Sanitizing data values</span>
        </div>
      </div>
      
      <div class="sanitation-step" data-step="indexing">
        <div class="flex items-center gap-3">
          <div class="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center">
            <div class="w-2 h-2 bg-slate-400 rounded-full"></div>
          </div>
          <span class="font-medium text-slate-700">Creating search index</span>
        </div>
      </div>
    </div>
    
    <!-- Issues Found -->
    <div id="sanitationIssues" class="hidden">
      <h4 class="font-medium text-slate-800 mb-3">Issues Found & Fixed</h4>
      <div class="space-y-2 max-h-48 overflow-y-auto">
        <div id="sanitationIssuesList" class="space-y-2"></div>
      </div>
    </div>
    
    <!-- Before/After Comparison -->
    <div id="sanitationComparison" class="hidden mt-6">
      <h4 class="font-medium text-slate-800 mb-3">Column Names - Before & After</h4>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <h5 class="text-sm font-medium text-red-600 mb-2">Original</h5>
          <div id="originalColumns" class="space-y-1 text-sm font-mono text-slate-600 max-h-32 overflow-y-auto"></div>
        </div>
        <div>
          <h5 class="text-sm font-medium text-green-600 mb-2">Cleaned</h5>
          <div id="cleanedColumns" class="space-y-1 text-sm font-mono text-slate-600 max-h-32 overflow-y-auto"></div>
        </div>
      </div>
    </div>
    
    <!-- Action Buttons -->
    <div id="sanitationActions" class="flex gap-3 justify-end mt-6 hidden">
      <button id="sanitationClose" class="px-4 py-2 text-slate-600 hover:text-slate-800 font-medium">Close</button>
      <button id="sanitationContinue" class="px-6 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg hover:from-blue-600 hover:to-indigo-700 font-medium">Continue</button>
    </div>
  </div>
</div>

</body>
</html>

