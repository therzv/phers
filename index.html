
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HR Data Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Beautiful moving sky blue gradient background */
    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(45deg, 
        #87CEEB 0%,   /* Sky blue */
        #E0F6FF 25%,  /* Light blue */
        #B8E6FF 50%,  /* Powder blue */
        #87CEFA 75%,  /* Light sky blue */
        #ADD8E6 100%  /* Light blue */
      );
      background-size: 400% 400%;
      animation: skyMove 15s ease-in-out infinite;
      position: relative;
      overflow-x: hidden;
    }
    
    /* Smooth sky gradient animation */
    @keyframes skyMove {
      0% { 
        background-position: 0% 50%; 
        background: linear-gradient(45deg, #87CEEB, #E0F6FF, #B8E6FF, #87CEFA, #ADD8E6);
      }
      25% { 
        background-position: 50% 0%; 
        background: linear-gradient(135deg, #E0F6FF, #B8E6FF, #87CEFA, #ADD8E6, #E6F3FF);
      }
      50% { 
        background-position: 100% 50%; 
        background: linear-gradient(225deg, #B8E6FF, #87CEFA, #ADD8E6, #E6F3FF, #87CEEB);
      }
      75% { 
        background-position: 50% 100%; 
        background: linear-gradient(315deg, #87CEFA, #ADD8E6, #E6F3FF, #87CEEB, #E0F6FF);
      }
      100% { 
        background-position: 0% 50%; 
        background: linear-gradient(45deg, #87CEEB, #E0F6FF, #B8E6FF, #87CEFA, #ADD8E6);
      }
    }
    
    /* Enhanced glass effect with floating animation */
    .glass { 
      background: rgba(255, 255, 255, 0.85); 
      backdrop-filter: blur(20px) saturate(180%); 
      box-shadow: 0 25px 50px rgba(8, 145, 178, 0.15), 
                  0 15px 35px rgba(8, 145, 178, 0.1),
                  inset 0 1px 0 rgba(255, 255, 255, 0.3); 
      border: 1px solid rgba(255, 255, 255, 0.2);
      animation: float 6s ease-in-out infinite;
    }
    
    /* Beautiful floating animation */
    @keyframes float {
      0%, 100% { 
        transform: translateY(0px) rotate(0deg); 
        box-shadow: 0 25px 50px rgba(8, 145, 178, 0.15), 
                    0 15px 35px rgba(8, 145, 178, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
      }
      50% { 
        transform: translateY(-10px) rotate(0.5deg); 
        box-shadow: 0 35px 60px rgba(8, 145, 178, 0.2), 
                    0 25px 45px rgba(8, 145, 178, 0.15),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4);
      }
    }
    
    /* Staggered animation for different containers */
    .col-span-1.glass {
      animation-delay: 0s;
    }
    
    .col-span-2.glass {
      animation-delay: 1s;
    }
    
    /* Enhanced hover effects */
    .panel-floating { 
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
    }
    .panel-floating:hover { 
      transform: translateY(-12px) scale(1.02); 
      box-shadow: 0 40px 80px rgba(8, 145, 178, 0.25), 
                  0 30px 60px rgba(8, 145, 178, 0.18),
                  inset 0 1px 0 rgba(255, 255, 255, 0.4);
    }
    
    /* Subtle cloud-like effects */
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.08) 0%, transparent 50%),
                  radial-gradient(circle at 40% 40%, rgba(135, 206, 235, 0.05) 0%, transparent 50%);
      animation: clouds 20s ease-in-out infinite;
      pointer-events: none;
    }
    
    @keyframes clouds {
      0%, 100% { transform: translateX(0) translateY(0); }
      33% { transform: translateX(-20px) translateY(-10px); }
      66% { transform: translateX(20px) translateY(10px); }
    }
    
    @media (prefers-reduced-motion: reduce) {
      body, .glass { animation: none !important; }
      .panel-floating { transition: none !important; }
      body::before { animation: none !important; }
    }
  </style>
</head>
<body>
  <div class="w-full max-w-6xl p-6">
    <div class="flex items-center justify-end mb-3">
      <div id="globalIndex" class="text-sm text-slate-600">Index: idle</div>
    </div>
    <div class="grid grid-cols-3 gap-6">
      <!-- Left: upload & files -->
      <div class="col-span-1 glass rounded-xl p-5 shadow panel-floating">
        <h2 class="text-lg font-semibold mb-3">Documents</h2>
        <div id="dbInfo" class="mb-3 text-xs text-slate-600">
          <div class="font-medium">Database</div>
          <div id="dbPath">No DB</div>
          <div id="dbTables" class="mt-1"></div>
        </div>
        <div class="mb-3">
          <input id="fileInput" type="file" accept=".csv,.xlsx,.xls" class="block w-full text-sm text-slate-600" multiple />
          <div class="flex mt-2 gap-2">
            <button id="uploadBtn" class="flex-1 bg-indigo-600 text-white px-3 py-2 rounded">Upload</button>
            <button id="refreshFiles" class="px-3 py-2 border rounded">Refresh</button>
          </div>
          <p id="uploadStatus" class="text-xs text-slate-500 mt-2"></p>
        </div>

        <div>
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-medium">Uploaded Files</h3>
            <div class="flex gap-1">
              <button id="activateAll" class="text-xs px-2 py-1 bg-emerald-100 text-emerald-700 rounded hover:bg-emerald-200">All On</button>
              <button id="deactivateAll" class="text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">All Off</button>
            </div>
          </div>
          <div id="activeFilesInfo" class="text-xs text-slate-600 mb-2 p-2 bg-blue-50 rounded hidden">
            <div class="font-medium">Active Files:</div>
            <div id="activeFilesList">None</div>
          </div>
          <div id="filesList" class="space-y-2 max-h-40 overflow-auto text-sm"></div>
        </div>
        <div class="mt-4">
          <h3 class="text-sm font-medium mb-2">Activity</h3>
          <div id="activityFeed" class="space-y-2 max-h-40 overflow-auto text-sm text-slate-600 p-2 bg-white rounded"></div>
        </div>
        <!-- chooser for ambiguous file matches -->
        <div id="chooser" class="mt-3 hidden">
          <div class="text-sm font-medium mb-2">Which file did you mean?</div>
          <div id="chooserList" class="space-y-2 text-sm"></div>
        </div>
      </div>

      <!-- Middle: chat -->
  <div class="col-span-2 glass rounded-xl p-5 shadow flex flex-col panel-floating">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h1 class="text-2xl font-bold text-slate-800">HR Data Chat</h1>
            <p class="text-sm text-slate-600 mt-1">Ask natural questions about your HR data</p>
          </div>
          <div class="text-right">
            <div class="text-sm text-slate-500">Powered by Ollama + Phi4</div>
            <div id="llmStatus" class="text-xs text-emerald-600">🟢 AI Ready</div>
          </div>
        </div>

        <div id="chat" class="flex-1 overflow-auto p-4 space-y-3 bg-gradient-to-b from-white to-slate-50 rounded border"></div>

        <div class="mt-4">
          <!-- Example questions -->
          <div id="exampleQuestions" class="mb-3 flex flex-wrap gap-2">
            <button class="example-q px-3 py-1 bg-slate-100 text-slate-700 rounded-full text-sm hover:bg-slate-200 transition-colors" data-question="How many assets are in repair status?">How many assets are in repair?</button>
            <button class="example-q px-3 py-1 bg-slate-100 text-slate-700 rounded-full text-sm hover:bg-slate-200 transition-colors" data-question="What is the total value of all machinery?">Total machinery value?</button>
            <button class="example-q px-3 py-1 bg-slate-100 text-slate-700 rounded-full text-sm hover:bg-slate-200 transition-colors" data-question="Show me all assets in Seattle">Assets in Seattle?</button>
            <button class="example-q px-3 py-1 bg-slate-100 text-slate-700 rounded-full text-sm hover:bg-slate-200 transition-colors" data-question="Count assets by category">Assets by category?</button>
          </div>
          
          <form id="form" class="flex gap-2">
            <input id="input" type="text" placeholder="Ask about assets, values, locations, status..." class="flex-1 px-4 py-3 rounded-lg border border-slate-300 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-200 outline-none" />
            <button type="submit" id="sendBtn" class="bg-emerald-600 text-white px-6 py-3 rounded-lg hover:bg-emerald-700 transition-colors font-medium">
              <span class="send-text">Ask AI</span>
              <span class="loading-text hidden">...</span>
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- SQL Preview Modal -->
  <div id="sqlModal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 bg-black opacity-40"></div>
    <div class="bg-white rounded-lg p-4 z-50 w-11/12 max-w-2xl panel-floating">
      <h3 class="font-semibold mb-2">Generated SQL (preview)</h3>
      <pre id="sqlText" class="bg-slate-50 p-3 rounded text-xs max-h-48 overflow-auto"></pre>
      <div id="sqlSuggestions" class="text-sm text-slate-600 mt-2"></div>
      <div id="sqlInferred" class="text-sm text-slate-600 mt-2"></div>
      <div class="mt-4 flex gap-2 justify-end">
        <button id="cancelSql" class="px-3 py-2 border rounded">Cancel</button>
        <button id="runSql" class="px-3 py-2 bg-emerald-600 text-white rounded">Run SQL</button>
      </div>
    </div>
  </div>

<script>
const chatEl = document.getElementById("chat");
const form = document.getElementById("form");
const input = document.getElementById("input");
const uploadBtn = document.getElementById("uploadBtn");
const fileInput = document.getElementById("fileInput");
const uploadStatus = document.getElementById("uploadStatus");
  const filesList = document.getElementById("filesList");
  const globalIndex = document.getElementById('globalIndex');
  const chooser = document.getElementById('chooser');
const refreshFiles = document.getElementById("refreshFiles");
const sqlModal = document.getElementById('sqlModal');
const sqlText = document.getElementById('sqlText');
const sqlSuggestions = document.getElementById('sqlSuggestions');
const sqlInferred = document.getElementById('sqlInferred');
const cancelSql = document.getElementById('cancelSql');
const runSql = document.getElementById('runSql');
const chooserList = document.getElementById('chooserList');
const activityFeed = document.getElementById('activityFeed');
const sendBtn = document.getElementById('sendBtn');
const sendText = sendBtn.querySelector('.send-text');
const loadingText = sendBtn.querySelector('.loading-text');
const activateAllBtn = document.getElementById('activateAll');
const deactivateAllBtn = document.getElementById('deactivateAll');
const activeFilesInfo = document.getElementById('activeFilesInfo');
const activeFilesList = document.getElementById('activeFilesList');

// Handle example question clicks
document.querySelectorAll('.example-q').forEach(btn => {
  btn.addEventListener('click', () => {
    const question = btn.dataset.question;
    input.value = question;
    form.dispatchEvent(new Event('submit'));
  });
});

// Bulk activation controls
activateAllBtn.addEventListener('click', async () => {
  activateAllBtn.disabled = true;
  activateAllBtn.innerText = 'Activating...';
  try {
    const res = await fetch('/files/activate-all', { method: 'POST' });
    const data = await res.json();
    if (res.ok) {
      await loadFiles();
      toast(data.message);
    } else {
      toast('Failed to activate all files');
    }
  } catch (e) {
    toast('Request failed: ' + e);
  }
  activateAllBtn.disabled = false;
  activateAllBtn.innerText = 'All On';
});

deactivateAllBtn.addEventListener('click', async () => {
  deactivateAllBtn.disabled = true;
  deactivateAllBtn.innerText = 'Deactivating...';
  try {
    const res = await fetch('/files/deactivate-all', { method: 'POST' });
    const data = await res.json();
    if (res.ok) {
      await loadFiles();
      toast(data.message);
    } else {
      toast('Failed to deactivate all files');
    }
  } catch (e) {
    toast('Request failed: ' + e);
  }
  deactivateAllBtn.disabled = false;
  deactivateAllBtn.innerText = 'All Off';
});

function setLoading(loading) {
  sendBtn.disabled = loading;
  if (loading) {
    sendText.classList.add('hidden');
    loadingText.classList.remove('hidden');
    sendBtn.classList.add('opacity-75');
  } else {
    sendText.classList.remove('hidden');
    loadingText.classList.add('hidden');
    sendBtn.classList.remove('opacity-75');
  }
}

function toast(msg){
  const t = document.createElement('div');
  t.className = 'fixed right-6 bottom-6 bg-white p-3 rounded shadow panel-floating text-sm';
  t.innerText = msg;
  document.body.appendChild(t);
  setTimeout(()=>{ t.style.opacity = '0'; setTimeout(()=>t.remove(), 350); }, 4000);
}

function addMessage(role, text, tablePreview) {
  const wrapper = document.createElement("div");
  wrapper.className = "flex " + (role === "user" ? "justify-end" : "justify-start");
  const bubble = document.createElement("div");
  bubble.className = (role === "user" ? "bg-indigo-600 text-white" : "bg-white border") + " px-4 py-2 rounded-lg max-w-3xl";
  bubble.innerText = text;
  wrapper.appendChild(bubble);
  if (tablePreview && tablePreview.length) {
    const table = document.createElement("div");
    table.className = "mt-2 overflow-auto text-xs bg-slate-50 border p-2 rounded";
    const keys = Object.keys(tablePreview[0] || {});
    if (keys.length) {
      const t = document.createElement("table");
      t.className = "min-w-full border-collapse text-left text-xs";
      const thead = document.createElement("thead");
      const trh = document.createElement("tr");
      keys.forEach(k=>{
        const th = document.createElement("th");
        th.innerText = k;
        th.className = "px-2 py-1 text-slate-600";
        trh.appendChild(th);
      });
      thead.appendChild(trh);
      t.appendChild(thead);
      const tbody = document.createElement("tbody");
      tablePreview.forEach(row=>{
        const tr = document.createElement("tr");
        keys.forEach(k=>{
          const td = document.createElement("td");
          td.innerText = row[k] ?? "";
          td.className = "px-2 py-1";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      t.appendChild(tbody);
      table.appendChild(t);
    } else {
      table.innerText = JSON.stringify(tablePreview, null, 2);
    }
    wrapper.appendChild(table);
  }
  chatEl.appendChild(wrapper);
  chatEl.scrollTop = chatEl.scrollHeight;
  return wrapper;
}

function parseSummary(summaryRaw){
  if(!summaryRaw) return '';
  let s = summaryRaw.trim();
  // strip fenced codeblocks
  const codeMatch = s.match(/```(?:json)?\n?([\s\S]*?)```/i);
  if(codeMatch){ s = codeMatch[1].trim(); }
  // try parse JSON
  try{
    const obj = JSON.parse(s);
    if(obj && obj.text) return obj.text;
  }catch(e){}
  // fallback: remove any surrounding backticks
  s = s.replace(/^`+|`+$/g, '').trim();
  return s;
}

async function renderAssistantResponse(resp, title){
  // resp: { summary, table_preview, suggestions }
  const summaryText = parseSummary(resp.summary || resp.text || '');
  const wrapper = addMessage('assistant', title ? title + '\n' + summaryText : (summaryText || 'No summary'), []);
  // suggestions
  const suggestions = resp.suggestions || [];
  if(suggestions && suggestions.length){
    const chips = document.createElement('div');
    chips.className = 'mt-2 flex gap-2 flex-wrap';
    suggestions.forEach((s, idx)=>{
      const btn = document.createElement('button');
      btn.className = 'text-sm px-3 py-1 bg-slate-100 text-slate-700 rounded-full border';
      const label = (s.candidates && s.candidates.length) ? `Did you mean "${s.candidates[0]}"?` : (s.original ? `Try "${s.original}"` : 'Try suggestion');
      btn.innerText = label;
      btn.addEventListener('click', async ()=>{
        btn.disabled = true;
        btn.innerText = 'Applying...';
        try{
          const sq = (s.suggested_sqls && s.suggested_sqls[0]) || s.suggested_sql || s.sql;
          const r = await fetch('/execute_sql', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sql: sq, question: (input.value||'') }) });
          const d = await r.json();
          if(!r.ok){
            toast('Suggestion failed: ' + (d.detail || JSON.stringify(d)));
            btn.disabled = false; btn.innerText = label;
            return;
          }
          // render the response (natural language + preview)
          await renderAssistantResponse(d, `Result for suggestion: ${label}`);
        }catch(err){
          toast('Suggestion request failed: ' + err);
          btn.disabled = false; btn.innerText = label;
        }
      });
      chips.appendChild(btn);
    });
    // append chips inside the same wrapper under the bubble
    wrapper.appendChild(chips);
    chatEl.scrollTop = chatEl.scrollHeight;
  }
}

async function loadFiles() {
  try {
    const res = await fetch('/files');
    const data = await res.json();
    filesList.innerHTML = '';
    data.files.forEach(f=>{
      const el = document.createElement('div');
  el.className = `p-2 border rounded flex flex-col gap-2 ${f.active ? 'border-emerald-300 bg-emerald-50' : 'border-gray-200 bg-gray-50 opacity-75'}`;
  el.innerHTML = `
    <div class="flex items-center justify-between">
      <div>
        <div class="flex items-center gap-2">
          <div class="font-medium">${f.filename}</div>
          <span class="text-xs px-2 py-1 rounded-full ${f.active ? 'bg-emerald-100 text-emerald-800' : 'bg-gray-100 text-gray-500'}">${f.active ? '✓ Active' : '⭕ Inactive'}</span>
        </div>
        <div class="text-xs text-slate-500">table: ${f.table}</div>
      </div>
    </div>
    <div class="w-full bg-slate-100 rounded h-2 overflow-hidden">
      <div id="bar-${f.filename}" class="h-2 bg-emerald-400" style="width:0%"></div>
    </div>`;
      const actions = document.createElement('div');
      actions.className = 'flex gap-2 mt-2';
      
      // activation toggle button
      const toggle = document.createElement('button');
      toggle.className = `px-2 py-1 rounded border text-xs ${f.active ? 'bg-orange-100 text-orange-700 border-orange-200 hover:bg-orange-200' : 'bg-emerald-100 text-emerald-700 border-emerald-200 hover:bg-emerald-200'}`;
      toggle.innerText = f.active ? 'Deactivate' : 'Activate';
      toggle.addEventListener('click', async ()=>{
        toggle.disabled = true;
        toggle.innerText = 'Updating...';
        try{
          const r = await fetch(`/files/${encodeURIComponent(f.filename)}/toggle`, { method: 'POST' });
          const d = await r.json();
          if (r.ok) {
            await loadFiles(); // Refresh the file list
            toast(d.message);
          } else {
            toast('Toggle failed: ' + (d.detail || JSON.stringify(d)));
          }
        }catch(e){
          toast('Toggle request failed: ' + e);
        }
        toggle.disabled = false;
      });
      actions.appendChild(toggle);
      
      // preview button
      const prev = document.createElement('button');
      prev.className = 'text-slate-700 px-2 py-1 rounded border bg-white hover:bg-slate-50 text-xs';
      prev.innerText = 'Preview';
      prev.addEventListener('click', async ()=>{
        prev.disabled = true;
        prev.innerText = 'Loading...';
        try{
          const sql = `SELECT * FROM "${f.table}" LIMIT 10`;
          const r = await fetch('/execute_sql', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ sql: sql, question: `Preview ${f.table}` }) });
          
          let d;
          try {
            d = await r.json();
          } catch (jsonError) {
            // If JSON parsing fails, try to get text response
            const text = await r.text();
            toast('Preview failed: Server returned invalid JSON. ' + (text.substring(0, 100) + '...'));
            return;
          }
          
          if (!r.ok){
            toast('Preview failed: ' + (d.detail || JSON.stringify(d)));
          } else {
            // show preview in chat as assistant message
            addMessage('assistant', `Preview of ${f.filename}`, d.table_preview || d.rows || []);
          }
        }catch(e){
          toast('Preview request failed: ' + e);
        }
        prev.disabled = false;
        prev.innerText = 'Preview';
      });
      actions.appendChild(prev);
      // delete button
      const del = document.createElement('button');
      del.className = 'text-red-600 px-2 py-1 rounded border bg-white hover:bg-red-50 text-xs';
      del.innerText = 'Delete';
      del.addEventListener('click', async ()=>{
        if (!confirm(`Delete ${f.filename}? This removes the file, its SQL table, and any RAG entries.`)) return;
        try {
          const res = await fetch(`/files/${encodeURIComponent(f.filename)}`, { method: 'DELETE' });
          if (res.ok) {
            await loadFiles();
          } else {
            const data = await res.json();
            alert('Delete failed: ' + (data.detail || JSON.stringify(data)));
          }
        } catch (e) {
          alert('Delete request failed: ' + e);
        }
      });
      actions.appendChild(del);
      el.appendChild(actions);
      filesList.appendChild(el);
    });
    
    // Update active files info
    const activeFiles = data.files.filter(f => f.active);
    if (activeFiles.length > 0) {
      activeFilesInfo.classList.remove('hidden');
      activeFilesList.innerHTML = activeFiles.map(f => f.filename).join(', ');
    } else {
      activeFilesInfo.classList.add('hidden');
      activeFilesList.innerHTML = 'None';
    }
    
    // then fetch indexing statuses and update badges
    try{
      const st = await fetch('/index_status');
      const js = await st.json();
      const s = js.status || {};
      let anyIndexing = false;
      Object.keys(s).forEach(fname=>{
        const info = s[fname];
        if (!info) return;
        const progress = Math.round((info.progress || 0)*100);
        const bar = document.getElementById('bar-'+fname);
        if (bar) {
          bar.style.width = `${progress}%`;
        }
        if (info.status === 'indexing'){
          anyIndexing = true;
        }
        // when just finished, push to activity feed and show toast
        if (info.status === 'done' && !document.getElementById('act-'+fname)){
          const feedItem = document.createElement('div');
          feedItem.id = 'act-'+fname;
          feedItem.innerHTML = `<div class="font-medium text-slate-700">Indexed ${fname}</div><div class="text-xs text-slate-500">Finished: ${info.finished || ''} • ${info.count||0} docs</div>`;
          activityFeed.prepend(feedItem);
          toast(`Indexing finished: ${fname}`);
        }
        if (info.status === 'error' && !document.getElementById('act-'+fname+'-err')){
          const feedItem = document.createElement('div');
          feedItem.id = 'act-'+fname+'-err';
          feedItem.innerHTML = `<div class="font-medium text-rose-600">Index error: ${fname}</div><div class="text-xs text-slate-500">${info.message || 'error'}</div>`;
          activityFeed.prepend(feedItem);
          toast(`Indexing error: ${fname}`);
        }
      })
      globalIndex.innerText = anyIndexing ? 'Indexing in progress...' : 'Index: idle';
    }catch(e){/* ignore */}
    // fetch db info
    try{
      const db = await fetch('/db_info');
      const d = await db.json();
      const dbPathEl = document.getElementById('dbPath');
      const dbTablesEl = document.getElementById('dbTables');
      if (d.db_path) dbPathEl.innerText = d.db_path;
      dbTablesEl.innerHTML = d.tables && d.tables.length ? ('Tables: ' + d.tables.join(', ')) : 'No tables';
    }catch(e){/* ignore */}
  } catch (e) {
    filesList.innerText = 'Failed to load files';
  }
}

// poll indexing status periodically
setInterval(()=>{ loadFiles(); }, 6000);

uploadBtn.addEventListener('click', async ()=>{
  const files = fileInput.files;
  if (!files || !files.length) {
    uploadStatus.innerText = 'Choose at least one file.';
    return;
  }
  uploadStatus.innerText = 'Uploading...';
  for (let i=0;i<files.length;i++){
    const fd = new FormData();
    fd.append('file', files[i]);
    try {
      const res = await fetch('/upload', { method: 'POST', body: fd });
      const data = await res.json();
      if (res.ok) {
        uploadStatus.innerText = `Uploaded: ${files[i].name}`;
      } else {
        uploadStatus.innerText = 'Upload error: ' + (data.detail || JSON.stringify(data));
      }
    } catch (e) {
      uploadStatus.innerText = 'Upload failed: ' + e;
    }
  }
  await loadFiles();
});

refreshFiles.addEventListener('click', loadFiles);

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const q = input.value.trim();
  if (!q) return;
  
  setLoading(true);
  addMessage('user', q);
  input.value = '';
  
  const thinkingMsg = addMessage('assistant', '🤔 Analyzing your question and searching the data...');
  
  try {
    const res = await fetch('/chat', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ question: q }) });
    const data = await res.json();
    // Remove thinking message
    thinkingMsg.remove();
    
    if (!res.ok) {
      addMessage('assistant', '❌ Error: ' + (data.detail || JSON.stringify(data)));
      setLoading(false);
      return;
    }
    // if no inferred tables and no suggestions, ask server for candidate files when ambiguous
    if ((!data.inferred_tables || !data.inferred_tables.length)){
      try{
        const pick = await fetch('/choose_file', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ question: q }) });
        const pickRes = await pick.json();
        if (pick.ok === false || !pickRes.candidates) {
          // ignore
        } else {
          const cand = pickRes.candidates || [];
          if (cand.length>1 && Math.abs((cand[0].score||0)-(cand[1].score||0)) < 0.6){
            // ambiguous — show chooser UI
            chooserList.innerHTML='';
            cand.forEach(c=>{
              const el = document.createElement('div');
              el.className='p-2 border rounded flex items-center justify-between';
              el.innerHTML = `<div><div class="font-medium">${c.filename}</div><div class="text-xs text-slate-500">table: ${c.table}</div></div>`
              const btn = document.createElement('button');
              btn.className='px-2 py-1 bg-indigo-600 text-white rounded';
              btn.innerText='Use this file';
              btn.addEventListener('click', ()=>{
                chooser.classList.add('hidden');
                // prefill question including explicit file hint and re-run preview flow
                const newQ = q + ` in file ${c.filename}`;
                input.value = newQ;
                form.dispatchEvent(new Event('submit'));
              });
              el.appendChild(btn);
              chooserList.appendChild(el);
            });
            chooser.classList.remove('hidden');
            return; // stop preview modal from showing; user will re-submit via chooser
          }
        }
      }catch(e){/*ignore chooser errors*/}
    }

    // If server returned no SQL (pandas-ai / dataframe-first flow), show the summary directly
    if (!data.sql) {
      // pandas-ai or direct summary path
      // render natural summary and preview
      await renderAssistantResponse(data);
      return;
    }
    // Automatically run the generated SQL and show a natural-language result + suggestions.
    // Keep the SQL preview modal as a manual "Show SQL" option.
    try{
      const executingMsg = addMessage('assistant', '⚡ Running SQL and composing an answer...');
      const exec = await fetch('/execute_sql', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ sql: data.sql, question: q }) });
      executingMsg.remove();
      const execData = await exec.json();
      if (!exec.ok) {
        // if server complains about unknown table, offer candidate chooser
        if (exec.status === 400 && execData && execData.detail && exec.headers.get('X-Candidates')) {
          try{
            const candidates = JSON.parse(exec.headers.get('X-Candidates'));
            // show chooser UI
            chooserList.innerHTML = '';
            candidates.forEach(c=>{
              const el = document.createElement('div');
              el.className='p-2 border rounded flex items-center justify-between';
              el.innerHTML = `<div><div class="font-medium">${c.filename}</div><div class="text-xs text-slate-500">table: ${c.table}</div></div>`;
              const btn = document.createElement('button');
              btn.className='px-2 py-1 bg-indigo-600 text-white rounded';
              btn.innerText='Use this file';
              btn.addEventListener('click', ()=>{
                chooser.classList.add('hidden');
                input.value = q + ` in file ${c.filename}`;
                form.dispatchEvent(new Event('submit'));
              });
              el.appendChild(btn);
              chooserList.appendChild(el);
            });
            chooser.classList.remove('hidden');
          }catch(e){
            addMessage('assistant', 'Execution error: ' + (execData.detail || JSON.stringify(execData)));
          }
        } else {
          addMessage('assistant', '❌ Execution error: ' + (execData.detail || JSON.stringify(execData)));
        }
      } else {
        // render natural-language summary + preview + suggestions
        await renderAssistantResponse(execData);
      }
      // still populate SQL preview modal content for transparency; user can open it manually
      sqlText.innerText = data.sql || '';
      sqlSuggestions.innerText = data.suggestions && data.suggestions.length ? ('Suggestions: ' + data.suggestions.join(' | ')) : '';
      sqlInferred.innerText = data.inferred_tables && data.inferred_tables.length ? ('Likely tables: ' + data.inferred_tables.join(', ')) : '';
    }catch(err){
      addMessage('assistant', '❌ Execution request failed: ' + err);
      // fallback to showing SQL modal so user can run manually
      sqlText.innerText = data.sql || '';
      sqlModal.classList.remove('hidden');
    }
  } catch (err) {
    addMessage('assistant', '❌ Request failed: ' + err);
  } finally {
    setLoading(false);
  }
});

// initial load
loadFiles();
</script>
</body>
</html>

